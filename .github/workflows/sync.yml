name: Sync

# åŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ = UTCæ—¶é—´18:00
on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    outputs:
      json_changed: ${{ steps.check_changes.outputs.changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºæ¯”è¾ƒ

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/6ool/holiday-cn.git
          git fetch upstream

      - name: Get current commit
        id: before_commit
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Sync from upstream
        run: |
          echo "ğŸ”„ åŒæ­¥ä¸Šæ¸¸ä»£ç ..."
          git fetch upstream
          git reset --hard upstream/master
          echo "âœ… ä¸Šæ¸¸åŒæ­¥å®Œæˆ"

      - name: Get new commit
        id: after_commit
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Check JSON changes
        id: check_changes
        run: |
          if [ "${{ steps.before_commit.outputs.sha }}" != "${{ steps.after_commit.outputs.sha }}" ]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰ JSON æ–‡ä»¶å˜æ›´
            if git diff --name-only ${{ steps.before_commit.outputs.sha }} ${{ steps.after_commit.outputs.sha }} | grep -E "\.json$"; then
              echo "changes=true" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ° JSON æ–‡ä»¶å˜æ›´"
            else
              echo "changes=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸  æ—  JSON æ–‡ä»¶å˜æ›´"
            fi
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  ä»£ç å·²æ˜¯æœ€æ–°"
          fi

      - name: Push to origin
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "ğŸ“¤ æ¨é€æ›´æ–°åˆ° origin..."
          git push origin master --force
          echo "âœ… æ¨é€å®Œæˆ"

  sync-to-ecs:
    needs: sync-upstream
    if: needs.sync-upstream.outputs.json_changed == 'true'
    runs-on: ubuntu-latest
    env:
      ECS_HOST: ${{ secrets.ECS_HOST }}
      ECS_PORT: ${{ secrets.ECS_PORT || '22' }}
      ECS_USER: ${{ secrets.ECS_USER }}
      ECS_SSH_KEY: ${{ secrets.ECS_SSH_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Sync files to Alibaba Cloud ECS
        run: |
          echo "ğŸ“¡ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°é˜¿é‡Œäº‘ ECS..."

          # æ£€æŸ¥å¿…è¦çš„ Secrets æ˜¯å¦é…ç½®
          if [ -z "$ECS_HOST" ] || [ -z "$ECS_USER" ] || [ -z "$ECS_SSH_KEY" ]; then
            echo "â­ï¸  ECS åŒæ­¥æœªé…ç½®ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
            echo "ğŸ’¡ å¦‚éœ€å¯ç”¨ï¼Œè¯·åœ¨ GitHub ä»“åº“ Settings > Secrets ä¸­é…ç½®ï¼š"
            echo "   - ECS_HOST"
            echo "   - ECS_PORT (å¯é€‰ï¼Œé»˜è®¤ 22)"
            echo "   - ECS_USER"
            echo "   - ECS_SSH_KEY"
            exit 0
          fi

          echo "ğŸš€ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°é˜¿é‡Œäº‘ ECS..."

          # è®¾ç½® SSH å¯†é’¥
          mkdir -p ~/.ssh
          echo "$ECS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p $ECS_PORT -H $ECS_HOST >> ~/.ssh/known_hosts 2>/dev/null

          # ç›®æ ‡è·¯å¾„
          TARGET_DIR="/api_data/holiday"

          echo "ğŸ“‚ ç›®æ ‡ç›®å½•: $TARGET_DIR"
          echo "ğŸ–¥ï¸  æœåŠ¡å™¨: $ECS_USER@$ECS_HOST:$ECS_PORT"

          # å…ˆåœ¨æœåŠ¡å™¨åˆ›å»ºç›®å½•ç»“æ„
          ssh -p $ECS_PORT -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            $ECS_USER@$ECS_HOST "mkdir -p $TARGET_DIR"

          # ä¸Šä¼ å¹´ä»½ JSON æ–‡ä»¶ (2007-2027.json)
          echo "ğŸ“¤ ä¸Šä¼ å¹´ä»½ JSON æ–‡ä»¶..."
          for year in {2007..2027}; do
            if [ -f "$year.json" ]; then
              scp -P $ECS_PORT -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
                $year.json $ECS_USER@$ECS_HOST:$TARGET_DIR/
              echo "  âœ“ $year.json"
            fi
          done

          # æ¸…ç†ç§é’¥
          rm -f ~/.ssh/id_rsa

          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
